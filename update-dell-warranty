/*This script will query the cmdb_ci_computer table for all computers that have a serial number and a manufacturer name that contains Dell. It will then query the Dell warranty API with each serial number, parse the
response to determine if there is a valid warranty for the given serial number and if so, insert or update the u_dell_warranty table with the warranty info. */

var CompanySysIds = ['0d0a10d0fc93f800546bb8590e0b58b7',  // Dell
                     '8edce90a414589409cf642b322142a1e',  // Dell
                                         'ab0c823c989738004675224672b91bcb',  // Dell Inc
                                                             'b7e7d7d8c0a8016900a5d7f291acce5c',  // Dell Inc.
                                                                                 'a8f99c90fc93f800546bb8590e0b58fe']; // Dell Incorporated

                                                                                 function Main(){
                                                                                        var record = new GlideRecord('cmdb_ci_computer');
                                                                                            record.addQuery('manufacturer', 'IN', CompanySysIds);
                                                                                                record.addNotNullQuery('serial_number');
                                                                                                    record.query();
                                                                                                        
                                                                                                            var counter = 0;
                                                                                                                var apiLimit = 10000;
                                                                                                                    //gs.log('There are '+record.getRowCount()+' records to check for Dell Warranty status');
                                                                                                                        while (record.next() ) {
                                                                                                                                    if (counter < apiLimit) {
                                                                                                                                                    var needsUpdate = CheckNeedsUpdate(record.serial_number);
                                                                                                                                                                if (needsUpdate) {
                                                                                                                                                                                    //gs.log('Querying Dell Warranty API:'+' Serial Number: '+record.serial_number+' Manufacturer: '+record.manufacturer);
                                                                                                                                                                                                    var request = new RESTMessage('Dell Warranty Sandbox', 'get');
                                                                                                                                                                                                                    request.setStringParameter('svctags', record.serial_number);
                                                                                                                                                                                                                                    var response = request.execute();
                                                                                                                                                                                                                                                    //gs.log('Dell Warranty API Response: '+response.getBody());
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                    //JSONParser Script Include is available with the JSON Web Service plugin
                                                                                                                                                                                                                                                                                                    var parser = new JSONParser();
                                                                                                                                                                                                                                                                                                                    var parsed = parser.parse(response.getBody());
                                                                                                                                                                                                                                                                                                                                    var gotResult = parsed.GetAssetWarrantyResponse.GetAssetWarrantyResult.Response;
                                                                                                                                                                                                                                                                                                                                                    if (gotResult != null){
                                                                                                                                                                                                                                                                                                                                                                            var warranty = parsed.GetAssetWarrantyResponse.GetAssetWarrantyResult.Response.DellAsset.Warranties.Warranty;
                                                                                                                                                                                                                                                                                                                                                                                                //gs.log('Dell Warranty: '+warranty);
                                                                                                                                                                                                                                                                                                                                                                                                                    if (warranty !== undefined && warranty !== null){       
                                                                                                                                                                                                                                                                                                                                                                                                                                                for (var i = 0; warranty[i]; i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                var existingWarranty =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                CheckExistingWarranty(record.serial_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                warranty[i]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                (existingWarranty
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ==
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                true)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    UpdateWarranty(record.serial_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    warranty[i]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        InsertWarranty(record.serial_number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        warranty[i]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //gs.log('Dell
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //Warranty
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //response
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //did
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //not
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //define
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //a
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //warranty
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //for
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                //'+record.serial_number);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                counter++;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                 }

                                                                                 // Check if the Warranty EndDate is > Now (Warranty is Active)
                                                                                 function CheckActive(a_end_date) {
                                                                                        var nowDateTime = gs.nowDateTime();
                                                                                            if (a_end_date > nowDateTime) {
                                                                                                        //gs.log('CheckActive() - Now: '+nowDateTime+' WarrantyEnd: '+a_end_date+' Active: true');
                                                                                                                return true;
                                                                                                                    } else {
                                                                                                                                //gs.log('CheckActive() - Now: '+nowDateTime+' WarrantyEnd: '+a_end_date+' Active: false');
                                                                                                                                        return false;
                                                                                                                                            }
                                                                                 }

                                                                                 // Check if the warranty record being updated has been updated in the last day
                                                                                 function CheckNeedsUpdate(a_serial_number) {
                                                                                        var gr = new GlideRecord('u_dell_warranty');
                                                                                            gr.addQuery('u_serialnumber', a_serial_number);
                                                                                                gr.query();
                                                                                                    //gs.log('Warranty table contains '+gr.getRowCount()+' records for serial number '+a_serial_number);
                                                                                                        while(gr.next()) {
                                                                                                                    var dateDiff = gs.dateDiff(gr.sys_updated_on, now(), true);
                                                                                                                            //gs.log('CheckNeedsUpdate() dateDiff: '+dateDiff);
                                                                                                                                    if (dateDiff < 86400) {
                                                                                                                                                    //gs.log('Warranty record: '+a_serial_number+' updated on :'+gr.sys_updated_on+', skipping update.');
                                                                                                                                                                return false;
                                                                                                                                                                        } else {
                                                                                                                                                                                        //gs.log('Warranty record for serial number '+a_serial_number+' last updated '+gr.sys_updated_on+' updating record.');
                                                                                                                                                                                                    return true;
                                                                                                                                                                                                            }   
                                                                                                                                                                                                                }
                                                                                                                                                                                                                    return true;
                                                                                 }

                                                                                 // Check if there is already a warranty record for this serial number
                                                                                 function CheckExistingWarranty(a_serial_number, a_warranty) {
                                                                                        var gr = new GlideRecord('u_dell_warranty');
                                                                                            gr.addQuery('u_serialnumber', a_serial_number);
                                                                                                gr.addQuery('u_itemnumber', a_warranty.ItemNumber);
                                                                                                    gr.query();
                                                                                                        var count = gr.getRowCount();
                                                                                                            if (count > 0) {
                                                                                                                        // Matching warranty found, update instead of insert.
                                                                                                                                //gs.log('Check for existing warranty found a match, updating entry.');
                                                                                                                                        return true;
                                                                                                                                            } else {
                                                                                                                                                        // No matching warranty found, insert the new data.
                                                                                                                                                                //gs.log('Check for existing warranty found no match, inserting entry.');
                                                                                                                                                                        return false;
                                                                                                                                                                            }
                                                                                 }

                                                                                 function InsertWarranty(a_serial_number, a_warranty) {
                                                                                        try {
                                                                                                    var gr = new GlideRecord('u_dell_warranty');
                                                                                                            gr.initialize();
                                                                                                                    gr.u_serialnumber = a_serial_number;
                                                                                                                            gr.u_entitlementtype = a_warranty.EntitlementType;
                                                                                                                                    if (JSUtil.type_of(a_warranty.ServiceProvider) == 'object') {
                                                                                                                                                        gr.u_serviceprovider = 'NULL';
                                                                                                                                                                } else {
                                                                                                                                                                                gr.u_serviceprovider = a_warranty.ServiceProvider;
                                                                                                                                                                                        }
                                                                                                                                                                                                gr.u_servicelevelgroup = a_warranty.ServiceLevelGroup;
                                                                                                                                                                                                        gr.u_itemnumber = a_warranty.ItemNumber;
                                                                                                                                                                                                                gr.u_serviceleveldescription = a_warranty.ServiceLevelDescription;
                                                                                                                                                                                                                        gr.u_servicelevelcode = a_warranty.ServiceLevelCode;
                                                                                                                                                                                                                                gr.u_startdate = a_warranty.StartDate;
                                                                                                                                                                                                                                        gr.u_enddate = a_warranty.EndDate;
                                                                                                                                                                                                                                                gr.u_active = CheckActive(a_warranty.EndDate);
                                                                                                                                                                                                                                                        gr.insert();
                                                                                                                                                                                                                                                            } catch (e) {
                                                                                                                                                                                                                                                                        gs.log('Error while Inserting Dell Warranty: '+e);
                                                                                                                                                                                                                                                                            }
                                                                                 }

                                                                                 function UpdateWarranty(a_serial_number, a_warranty) {
                                                                                        try {
                                                                                                    var gr = new GlideRecord('u_dell_warranty');
                                                                                                            gr.addQuery('u_serialnumber', a_serial_number);
                                                                                                                    gr.addQuery('u_itemnumber', a_warranty.ItemNumber);
                                                                                                                            gr.query();
                                                                                                                                    while(gr.next()) {
                                                                                                                                                    gr.u_serialnumber = a_serial_number;
                                                                                                                                                                gr.u_entitlementtype = a_warranty.EntitlementType;
                                                                                                                                                                            if (JSUtil.type_of(a_warranty.ServiceProvider) == 'object') {
                                                                                                                                                                                                    gr.u_serviceprovider = 'NULL';
                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                    gr.u_serviceprovider = a_warranty.ServiceProvider;
                                                                                                                                                                                                                                                }   
                                                                                                                                                                                                                                                            gr.u_servicelevelgroup = a_warranty.ServiceLevelGroup;
                                                                                                                                                                                                                                                                        gr.u_itemnumber = a_warranty.ItemNumber;
                                                                                                                                                                                                                                                                                    gr.u_serviceleveldescription = a_warranty.ServiceLevelDescription;
                                                                                                                                                                                                                                                                                                gr.u_servicelevelcode = a_warranty.ServiceLevelCode;
                                                                                                                                                                                                                                                                                                            gr.u_startdate = a_warranty.StartDate;
                                                                                                                                                                                                                                                                                                                        gr.u_enddate = a_warranty.EndDate;
                                                                                                                                                                                                                                                                                                                                    gr.u_active = CheckActive(a_warranty.EndDate);
                                                                                                                                                                                                                                                                                                                                                gr.sys_updated_on = gs.now();
                                                                                                                                                                                                                                                                                                                                                            gr.update();    
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                        } catch(e) {
                                                                                                                                                                                                                                                                                                                                                                                    gs.log('Error while Updating Dell Warranty: '+e);
                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                 }

                                                                                 Main();
